{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign Up — Confirm It</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* ... (Keep your existing CSS variables and layout styles) ... */
        :root {
            --brand-dark: #121212;
            --brand-card: #151515;
            --brand-border: #3a3a3a;
            --brand-green: #27ae60; 
            --brand-green-bright: #4ade80;
            --brand-green-dim: rgba(39, 174, 96, 0.1);
            --brand-text: #e0e0e0; 
            --brand-text-grey: #a0a0a0;
            --font-main: 'Inter', sans-serif;
            --error-red: #ff4d4f;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: var(--font-main);
            background-color: var(--brand-dark);
            color: var(--brand-text);
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh; padding: 20px;
        }

        .container {
            width: 100%; max-width: 900px; height: 600px;
            display: flex; border-radius: 24px; overflow: hidden;
            background-color: var(--brand-card);
            border: 1px solid var(--brand-border);
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
            position: relative;
        }

        .left-panel {
            width: 45%; background-color: #0f0f0f;
            display: flex; flex-direction: column; justify-content: space-between;
            padding: 40px; border-right: 1px solid var(--brand-border);
            position: relative; overflow: hidden;
        }
        
        .logo img { height: 40px; width: auto; }
        
        .steps-indicator { display: flex; flex-direction: column; gap: 20px; margin-top: 40px; }
        .step-item { display: flex; align-items: center; gap: 15px; opacity: 0.4; transition: 0.3s; }
        .step-item.active { opacity: 1; }
        .step-number {
            width: 32px; height: 32px; border-radius: 50%; border: 1px solid var(--brand-text);
            display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px;
        }
        .step-item.active .step-number { background-color: var(--brand-green); border-color: var(--brand-green); color: black; }
        .step-text h4 { font-size: 14px; font-weight: 600; }
        .step-text p { font-size: 12px; color: var(--brand-text-grey); margin-top: 2px; }

        .form-panel { width: 55%; padding: 50px; display: flex; flex-direction: column; position: relative; }
        
        .form-header { margin-bottom: 30px; display: flex; align-items: center; justify-content: space-between; }
        .form-header h2 { font-size: 24px; font-weight: 700; color: white; }
        .back-btn { 
            background: none; border: none; color: var(--brand-text-grey); cursor: pointer; 
            font-size: 24px; display: none; padding: 0; transition: 0.2s;
        }
        .back-btn:hover { color: white; transform: translateX(-3px); }

        .step-section { display: none; animation: fadeIn 0.4s ease-out; }
        .step-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .input-group { margin-bottom: 20px; }
        .half-group { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        
        label { display: block; font-size: 12px; color: var(--brand-text-grey); margin-bottom: 8px; font-weight: 500; }
        
        input, select {
            width: 100%; padding: 12px 16px; background-color: #1a1a1a;
            border: 1px solid var(--brand-border); border-radius: 8px;
            color: white; font-size: 14px; outline: none; transition: 0.2s;
        }
        input:focus { border-color: var(--brand-green); background-color: #222; }
        input.input-error { border-color: var(--error-red); }
        .error-msg { color: var(--error-red); font-size: 11px; margin-top: 5px; display: none; }

        .btn-primary {
            width: 100%; padding: 14px; background-color: var(--brand-green);
            color: black; border: none; border-radius: 8px; font-weight: 700; font-size: 14px;
            cursor: pointer; transition: 0.2s; margin-top: 10px;
        }
        .btn-primary:hover { background-color: var(--brand-green-bright); transform: translateY(-1px); }

        .login-link { margin-top: auto; text-align: center; font-size: 13px; color: var(--brand-text-grey); }
        .login-link a { color: var(--brand-green); text-decoration: none; font-weight: 600; }
        .login-link a:hover { text-decoration: underline; }

        /* --- CUSTOM DROPDOWN --- */
        .custom-select-wrapper { position: relative; user-select: none; }
        .custom-select { position: relative; display: flex; flex-direction: column; }
        .custom-select-trigger {
            position: relative; display: flex; align-items: center; justify-content: space-between;
            padding: 12px 16px; font-size: 14px; color: #fff; background: #1a1a1a;
            border: 1px solid var(--brand-border); border-radius: 8px; cursor: pointer; transition: 0.2s;
        }
        .custom-options {
            position: absolute; display: block; top: 100%; left: 0; right: 0;
            border: 1px solid var(--brand-green); border-radius: 8px; background: #1a1a1a;
            transition: all 0.2s; opacity: 0; visibility: hidden; pointer-events: none; z-index: 10;
            margin-top: 5px; box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        }
        .custom-select.open .custom-options { opacity: 1; visibility: visible; pointer-events: all; }
        .custom-option {
            padding: 12px 16px; font-size: 14px; color: #e0e0e0; cursor: pointer; transition: 0.2s;
        }
        .custom-option:hover { background-color: var(--brand-green); color: black; }
        .custom-option.selected { background-color: var(--brand-green-dim); color: var(--brand-green); }
        .arrow {
            width: 10px; height: 10px; border-bottom: 2px solid var(--brand-text-grey); border-right: 2px solid var(--brand-text-grey);
            transform: rotate(45deg); transition: 0.2s; margin-top: -4px;
        }
        .custom-select.open .arrow { transform: rotate(-135deg); margin-top: 4px; border-color: var(--brand-green); }

        /* --- MODAL STYLES (NEW) --- */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.8); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(5px);
        }
        .modal {
            background-color: var(--brand-card); border: 1px solid var(--brand-border); border-radius: 16px;
            padding: 40px; width: 90%; max-width: 420px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.7);
            animation: fadeIn 0.3s;
        }
        .modal h3 { margin-bottom: 10px; font-size: 20px; color: white; }
        .modal p { color: var(--brand-text-grey); font-size: 14px; margin-bottom: 30px; line-height: 1.5; }
        
        .otp-container { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; }
        .otp-input {
            width: 55px; height: 55px; border-radius: 12px; border: 1px solid var(--brand-border);
            background-color: #1a1a1a; color: white; font-size: 24px; text-align: center; font-weight: bold;
            transition: all 0.2s;
        }
        .otp-input:focus { border-color: var(--brand-green); box-shadow: 0 0 15px var(--brand-green-dim); outline: none; }
        .otp-input.input-error { border-color: var(--error-red); }

        /* NEW: OTP Error Container */
        #otp-global-error { 
            color: var(--error-red); 
            font-size: 12px; 
            margin-bottom: 25px; 
            display: none; 
            font-weight: 500;
        }

        .modal-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .btn-cancel {
            background: transparent; border: 1px solid var(--brand-border); color: var(--brand-text);
            padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600;
        }
        .btn-cancel:hover { background: rgba(255,255,255,0.05); border-color: white; }
        .btn-verify {
            background: var(--brand-green); border: none; color: black;
            padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 700;
        }
        .btn-verify:hover { background: var(--brand-green-bright); }

        .resend-link {
            display: block; margin-top: 20px; color: var(--brand-text-grey); font-size: 13px;
            text-decoration: underline; cursor: pointer; background: none; border: none; width: 100%;
        }
        .resend-link:hover { color: var(--brand-green); }
        .resend-link:disabled { opacity: 0.5; cursor: not-allowed; color: var(--brand-text-grey); text-decoration: none; }
        
        #resendMsg { color: var(--brand-green); font-size: 13px; margin-top: 10px; display: none; }

    </style>
</head>
<body>

    <div id="phoneModal" class="modal-overlay">
        <div class="modal">
            <h3>Verify Phone Number</h3>
            <p>We've sent a verification code via WhatsApp to <br><strong id="displayPhone" style="color:white;"></strong></p>
            
            <div class="otp-container">
                <input type="text" class="otp-input" maxlength="1" oninput="handleOtpInput(this)">
                <input type="text" class="otp-input" maxlength="1" oninput="handleOtpInput(this)">
                <input type="text" class="otp-input" maxlength="1" oninput="handleOtpInput(this)">
                <input type="text" class="otp-input" maxlength="1" oninput="handleOtpInput(this)">
            </div>

            <div id="otp-global-error">Incorrect code. Please try again.</div>

            <div class="modal-actions">
                <button type="button" class="btn-cancel" onclick="closeVerificationModal()">Cancel</button>
                <button type="button" class="btn-verify" onclick="verifyAndProceed()">Verify</button>
            </div>

            <button type="button" class="resend-link" id="resendBtn" onclick="resendCode()">Resend Code</button>
            <div id="resendMsg">Code sent successfully!</div>
        </div>
    </div>
    <div class="container">
        <div class="left-panel">
            <div class="logo">
                <img src="{% static 'orders/imgs/logooo.png' %}" alt="Confirm It Logo">
            </div>
            
            <div class="steps-indicator">
                <div class="step-item active" id="indicator1">
                    <div class="step-number">1</div>
                    <div class="step-text">
                        <h4>Personal Details</h4>
                        <p>Your name, contact & security</p>
                    </div>
                </div>
                <div class="step-item" id="indicator2">
                    <div class="step-number">2</div>
                    <div class="step-text">
                        <h4>Business Info</h4>
                        <p>Brand name & Logistics</p>
                    </div>
                </div>
            </div>

            <div style="margin-top: auto; opacity: 0.5; font-size: 11px;">
                © 2025 Confirm It Inc.
            </div>
        </div>

        <div class="form-panel">
            <div class="form-header">
                <button type="button" class="back-btn" id="backArrowBtn" onclick="goBackToStep1()">←</button>
                <h2 id="formTitle">Create Account</h2>
            </div>

            <form method="POST" action="" id="signupForm">
                {% csrf_token %}
                
                <div id="step1" class="step-section active">
                    <div class="half-group">
                        <div class="input-group">
                            <label>First Name</label>
                            <input type="text" name="first_name" id="first_name" placeholder="" value="{{ form_data.first_name }}">
                            <div class="error-msg" id="err-first_name">{{ errors.first_name }}</div>
                        </div>
                        <div class="input-group">
                            <label>Last Name</label>
                            <input type="text" name="last_name" id="last_name" placeholder="" value="{{ form_data.last_name }}">
                            <div class="error-msg" id="err-last_name">{{ errors.last_name }}</div>
                        </div>
                    </div>

                    <div class="input-group">
                        <label>Email Address</label>
                        <input type="email" name="email" id="email" placeholder="" value="{{ form_data.email }}">
                        <div class="error-msg" id="err-email">{{ errors.email }}</div>
                    </div>

                    <div class="input-group">
                        <label>Phone Number (WhatsApp)</label>
                        <input type="text" name="phone" id="phone" placeholder="" value="{{ form_data.phone }}">
                        <div class="error-msg" id="err-phone">{{ errors.phone }}</div>
                    </div>

                    <div class="half-group">
                        <div class="input-group">
                            <label>Password</label>
                            <input type="password" name="password" id="password" placeholder="********">
                            <div class="error-msg" id="err-password">{{ errors.password }}</div>
                        </div>
                        <div class="input-group">
                            <label>Confirm Password</label>
                            <input type="password" name="confirm_password" id="confirm_password" placeholder="********">
                            <div class="error-msg" id="err-confirm_password">{{ errors.confirm_password }}</div>
                        </div>
                    </div>

                    <button type="button" class="btn-primary" id="nextBtn" onclick="validateStep1()">Next Step</button>
                </div>

                <div id="step2" class="step-section">
                    <div class="input-group">
                        <label>Brand Name</label>
                        <input type="text" name="brand_name" id="brand_name" placeholder="" value="{{ form_data.brand_name }}">
                        <div class="error-msg" id="err-brand_name">{{ errors.brand_name }}</div>
                    </div>

                    <div class="input-group">
                        <label>Website URL (Optional)</label>
                        <input type="text" name="website" id="website" placeholder="https://..." value="{{ form_data.website }}">
                        <div class="error-msg" id="err-website">{{ errors.website }}</div>
                    </div>

                    <div class="input-group">
                        <label>Delivery Partner</label>
                        
                        <input type="hidden" name="delivery_company" id="delivery_company" value="{{ form_data.delivery_company }}">
                        
                        <div class="custom-select-wrapper">
                            <div class="custom-select" id="deliverySelect">
                                <div class="custom-select-trigger">
                                    <span class="selection-text">Select your courier...</span>
                                    <div class="arrow"></div>
                                </div>
                                <div class="custom-options">
                                    <div class="custom-option" data-value="bosta">Bosta</div>
                                    <div class="custom-option" data-value="aramex">Aramex</div>
                                    <div class="custom-option" data-value="khazenly">Khazenly</div>
                                    <div class="custom-option" data-value="other">Other/Not Listed</div>
                                </div>
                            </div>
                        </div>
                        <div class="error-msg" id="err-delivery_company">{{ errors.delivery_company }}</div>
                    </div>

                    <button type="submit" class="btn-primary">Create Account</button>
                </div>
            </form>

            <div class="login-link">
                Already have an account? <a href="{% url 'login' %}">Log in</a>
            </div>
        </div>
    </div>

    <script>
        // --- STEP 1 VALIDATION & OTP TRIGGER ---
        function validateStep1() {
            // 1. Clear previous errors
            document.querySelectorAll('.error-msg').forEach(el => el.style.display = 'none');
            document.querySelectorAll('input').forEach(el => el.classList.remove('input-error'));

            let hasFrontendErrors = false;
            
            // 2. Get values
            const first = document.getElementById('first_name').value.trim();
            const last = document.getElementById('last_name').value.trim();
            const email = document.getElementById('email').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const pass = document.getElementById('password').value;
            const confirm = document.getElementById('confirm_password').value;

            // 3. Simple Frontend Logic Checks
            if(!first) { showError('first_name', 'Required'); hasFrontendErrors = true; }
            if(!last) { showError('last_name', 'Required'); hasFrontendErrors = true; }
            if(!email || !email.includes('@')) { showError('email', 'Valid email required'); hasFrontendErrors = true; }
            if(!phone || phone.length < 10) { showError('phone', 'Valid phone required'); hasFrontendErrors = true; }
            if(!pass || pass.length < 8) { showError('password', 'Min 8 chars required'); hasFrontendErrors = true; }
            if(pass !== confirm) { showError('confirm_password', 'Passwords do not match'); hasFrontendErrors = true; }

            if(hasFrontendErrors) return;

            // 4. Backend Validation (Check Duplicates & Send OTP)
            // Change button to loading state
            const nextBtn = document.getElementById('nextBtn');
            const originalText = nextBtn.innerText;
            nextBtn.innerText = "Checking...";
            nextBtn.disabled = true;

            fetch(`{% url 'send_otp' %}?email=${encodeURIComponent(email)}&phone=${encodeURIComponent(phone)}`)
            .then(response => response.json())
            .then(data => {
                nextBtn.innerText = originalText;
                nextBtn.disabled = false;

                if (data.errors) {
                    // Show Backend Validation Errors
                    if(data.errors.email) showError('email', data.errors.email);
                    if(data.errors.phone) showError('phone', data.errors.phone);
                } else if (data.status === 'sent') {
                    // Success -> Open Modal
                    openVerificationModal(phone);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                nextBtn.innerText = originalText;
                nextBtn.disabled = false;
                alert("Something went wrong. Please try again.");
            });
        }

        function showError(id, msg) {
            const el = document.getElementById(id);
            const errDiv = document.getElementById('err-' + id);
            if(el) el.classList.add('input-error');
            if(errDiv) {
                errDiv.innerText = msg;
                errDiv.style.display = 'block';
            }
        }

        // --- MODAL LOGIC ---
        const modal = document.getElementById('phoneModal');
        const displayPhone = document.getElementById('displayPhone');
        const otpErrorDiv = document.getElementById('otp-global-error');

        function openVerificationModal(phone) {

            let formattedPhone = phone.trim();
            if (!formattedPhone.startsWith('+')) {
                formattedPhone = '+' + formattedPhone;
                  }

            displayPhone.innerText = formattedPhone;
            modal.style.display = 'flex';
            otpErrorDiv.style.display = 'none'; // Clear previous errors
            
            // Start timer immediately upon opening (code was just sent)
            startResendTimer();
            
            setTimeout(() => document.querySelector('.otp-input').focus(), 100);
        }

        function closeVerificationModal() {
            modal.style.display = 'none';
            document.querySelectorAll('.otp-input').forEach(input => {
                input.value = '';
                input.classList.remove('input-error');
            });
        }

        function verifyAndProceed() {
            // 1. Collect Code
            let code = "";
            document.querySelectorAll('.otp-input').forEach(input => code += input.value);

            if(code.length !== 4) {
                // Show error under boxes if incomplete
                otpErrorDiv.innerText = "Please enter the full 4-digit code.";
                otpErrorDiv.style.display = 'block';
                return;
            }

            // 2. Call Verify Endpoint
            const verifyBtn = document.querySelector('.btn-verify');
            verifyBtn.innerText = "Verifying...";
            verifyBtn.disabled = true;

            fetch(`{% url 'verify_otp' %}?code=${code}`)
            .then(response => response.json())
            .then(data => {
                verifyBtn.innerText = "Verify";
                verifyBtn.disabled = false;

                if(data.status === 'verified') {
                    // Success: Close modal -> Go to Step 2
                    closeVerificationModal();
                    showStep2(); 
                } else {
                    // Show error under boxes
                    otpErrorDiv.innerText = data.error || "Invalid code.";
                    otpErrorDiv.style.display = 'block';
                    // Add red border to inputs
                    document.querySelectorAll('.otp-input').forEach(el => el.classList.add('input-error'));
                }
            })
            .catch(err => {
                verifyBtn.innerText = "Verify";
                verifyBtn.disabled = false;
                alert("Verification failed. Please try again.");
            });
        }

        // --- RESEND TIMER LOGIC ---
        let resendTimer;
        const resendBtn = document.getElementById('resendBtn');
        
        function startResendTimer() {
            let timeLeft = 60;
            resendBtn.disabled = true;
            resendBtn.innerText = `Resend Code (${timeLeft}s)`;
            
            clearInterval(resendTimer);
            resendTimer = setInterval(() => {
                timeLeft--;
                resendBtn.innerText = `Resend Code (${timeLeft}s)`;
                
                if (timeLeft <= 0) {
                    clearInterval(resendTimer);
                    resendBtn.disabled = false;
                    resendBtn.innerText = "Resend Code";
                }
            }, 1000);
        }

        function resendCode() {
            const phone = document.getElementById('phone').value.trim();
            const email = document.getElementById('email').value.trim();
            
            // Trigger backend send
            fetch(`{% url 'send_otp' %}?email=${encodeURIComponent(email)}&phone=${encodeURIComponent(phone)}`)
            .then(response => response.json())
            .then(data => {
                if(data.status === 'sent') {
                    const msg = document.getElementById('resendMsg');
                    msg.style.display = 'block';
                    setTimeout(() => { msg.style.display = 'none'; }, 3000);
                    
                    // Restart timer
                    startResendTimer();
                }
            });
        }

        function handleOtpInput(element) {
            // Clear error style on typing
            document.querySelectorAll('.otp-input').forEach(el => el.classList.remove('input-error'));
            otpErrorDiv.style.display = 'none';

            if (element.value.length === 1) {
                const nextInput = element.nextElementSibling;
                if (nextInput && nextInput.tagName === 'INPUT') {
                    nextInput.focus();
                }
            }
        }
        
        document.querySelectorAll('.otp-input').forEach(input => {
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Backspace' && this.value.length === 0) {
                    const prevInput = this.previousElementSibling;
                    if (prevInput) prevInput.focus();
                }
            });
        });


        // --- STEP NAVIGATION UI ---
        function showStep2() {
            document.getElementById('step1').classList.remove('active');
            document.getElementById('step2').classList.add('active');
            
            document.getElementById('indicator1').classList.remove('active');
            document.getElementById('indicator2').classList.add('active');
            
            document.getElementById('backArrowBtn').style.display = 'block';
            document.getElementById('formTitle').innerText = "Business Details";
        }

        function goBackToStep1() {
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step1').classList.add('active');
            
            document.getElementById('indicator2').classList.remove('active');
            document.getElementById('indicator1').classList.add('active');
            
            document.getElementById('backArrowBtn').style.display = 'none';
            document.getElementById('formTitle').innerText = "Create Account";
        }

        // --- DROPDOWN LOGIC ---
        document.addEventListener('DOMContentLoaded', function() {
            const selectContainer = document.querySelector('.custom-select');
            const trigger = selectContainer.querySelector('.custom-select-trigger');
            const options = selectContainer.querySelectorAll('.custom-option');
            const hiddenInput = document.getElementById('delivery_company');
            const selectionText = selectContainer.querySelector('.selection-text');

            trigger.addEventListener('click', function(e) {
                e.stopPropagation(); 
                selectContainer.classList.toggle('open');
            });

            options.forEach(option => {
                option.addEventListener('click', function() {
                    options.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    selectionText.textContent = this.textContent;
                    hiddenInput.value = this.getAttribute('data-value');
                    selectContainer.classList.remove('open');
                });
            });

            window.addEventListener('click', function(e) {
                if (!selectContainer.contains(e.target)) {
                    selectContainer.classList.remove('open');
                }
            });
        });
    </script>

</body>
</html>